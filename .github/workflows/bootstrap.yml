# =============================================================================
# Bootstrap - Create S3 bucket and DynamoDB table for Terraform state
# =============================================================================
# Run this workflow ONCE manually to create the state backend
# =============================================================================

name: Bootstrap Infrastructure

on:
  workflow_dispatch:

env:
  AWS_REGION: 'eu-west-1'

jobs:
  bootstrap:
    name: Create Terraform State Backend
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Create S3 Bucket
        run: |
          if aws s3api head-bucket --bucket koumpa-terraform-state 2>/dev/null; then
            echo "Bucket already exists"
          else
            aws s3api create-bucket \
              --bucket koumpa-terraform-state \
              --region $AWS_REGION \
              --create-bucket-configuration LocationConstraint=$AWS_REGION
            echo "Bucket created"
          fi

      - name: Enable Bucket Versioning
        run: |
          aws s3api put-bucket-versioning \
            --bucket koumpa-terraform-state \
            --versioning-configuration Status=Enabled

      - name: Enable Bucket Encryption
        run: |
          aws s3api put-bucket-encryption \
            --bucket koumpa-terraform-state \
            --server-side-encryption-configuration '{"Rules":[{"ApplyServerSideEncryptionByDefault":{"SSEAlgorithm":"AES256"}}]}'

      - name: Block Public Access
        run: |
          aws s3api put-public-access-block \
            --bucket koumpa-terraform-state \
            --public-access-block-configuration "BlockPublicAcls=true,IgnorePublicAcls=true,BlockPublicPolicy=true,RestrictPublicBuckets=true"

      - name: Create DynamoDB Table
        run: |
          if aws dynamodb describe-table --table-name koumpa-terraform-locks 2>/dev/null; then
            echo "Table already exists"
          else
            aws dynamodb create-table \
              --table-name koumpa-terraform-locks \
              --attribute-definitions AttributeName=LockID,AttributeType=S \
              --key-schema AttributeName=LockID,KeyType=HASH \
              --billing-mode PAY_PER_REQUEST \
              --region $AWS_REGION
            echo "Table created"
          fi

      - name: Summary
        run: |
          echo "## Bootstrap Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- S3 Bucket: koumpa-terraform-state" >> $GITHUB_STEP_SUMMARY
          echo "- DynamoDB Table: koumpa-terraform-locks" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "You can now run the Infrastructure workflow." >> $GITHUB_STEP_SUMMARY

# =============================================================================
# GitLab CI/CD Pipeline for Koumpa Infrastructure
# =============================================================================
#
# Branches:
#   - staging: Déploiement automatique sur push
#   - main: Déploiement manuel via Merge Request (auto après merge)
#
# Pipelines séparés:
#   - Infrastructure (Terraform)
#   - Application (Lambda functions)
# =============================================================================

stages:
  - validate
  - test
  - build
  - deploy-staging
  - deploy-prod

variables:
  TF_VERSION: "1.5.0"
  NODE_VERSION: "20"
  AWS_DEFAULT_REGION: "eu-west-1"
  TF_IN_AUTOMATION: "true"

# =============================================================================
# Templates réutilisables
# =============================================================================

.terraform_template: &terraform_template
  image:
    name: hashicorp/terraform:$TF_VERSION
    entrypoint: [""]
  before_script:
    - apk add --no-cache aws-cli
  cache:
    key: terraform-${CI_COMMIT_REF_SLUG}
    paths:
      - .terraform/

.node_template: &node_template
  image: node:${NODE_VERSION}-alpine
  before_script:
    - apk add --no-cache zip
  cache:
    key: node-${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
      - src/lambdas/shared/node_modules/

# =============================================================================
# INFRASTRUCTURE PIPELINE
# =============================================================================

# -----------------------------------------------------------------------------
# Validation
# -----------------------------------------------------------------------------

infra:validate:
  <<: *terraform_template
  stage: validate
  script:
    - echo "Validating Terraform configuration..."
    - cd terraform/environments/staging && terraform init -backend=false && terraform validate
    - cd ../prod && terraform init -backend=false && terraform validate
  rules:
    - changes:
        - terraform/**/*
      when: always

infra:fmt-check:
  <<: *terraform_template
  stage: validate
  script:
    - terraform fmt -check -recursive terraform/
  allow_failure: true
  rules:
    - changes:
        - terraform/**/*
      when: always

# -----------------------------------------------------------------------------
# Plan (pour review dans les MR)
# -----------------------------------------------------------------------------

infra:plan-staging:
  <<: *terraform_template
  stage: test
  script:
    - cd terraform/environments/staging
    - terraform init
    - terraform plan -out=staging.tfplan
  artifacts:
    paths:
      - terraform/environments/staging/staging.tfplan
    expire_in: 1 day
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      changes:
        - terraform/**/*
    - if: '$CI_COMMIT_BRANCH == "staging"'
      changes:
        - terraform/**/*

infra:plan-prod:
  <<: *terraform_template
  stage: test
  script:
    - cd terraform/environments/prod
    - terraform init
    - terraform plan -out=prod.tfplan
  artifacts:
    paths:
      - terraform/environments/prod/prod.tfplan
    expire_in: 1 day
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event" && $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main"'
      changes:
        - terraform/**/*
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - terraform/**/*

# -----------------------------------------------------------------------------
# Deploy Staging (automatique sur push)
# -----------------------------------------------------------------------------

infra:deploy-staging:
  <<: *terraform_template
  stage: deploy-staging
  script:
    - cd terraform/environments/staging
    - terraform init
    - terraform apply -auto-approve
  environment:
    name: staging
    url: https://staging.koumpa.com
  rules:
    - if: '$CI_COMMIT_BRANCH == "staging"'
      changes:
        - terraform/**/*
      when: always

# -----------------------------------------------------------------------------
# Deploy Production (automatique après merge sur main)
# -----------------------------------------------------------------------------

infra:deploy-prod:
  <<: *terraform_template
  stage: deploy-prod
  script:
    - cd terraform/environments/prod
    - terraform init
    - terraform apply -auto-approve
  environment:
    name: production
    url: https://koumpa.com
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - terraform/**/*
      when: always

# =============================================================================
# APPLICATION PIPELINE (Lambda Functions)
# =============================================================================

# -----------------------------------------------------------------------------
# Test
# -----------------------------------------------------------------------------

app:test:
  <<: *node_template
  stage: test
  script:
    - cd src/lambdas/shared
    - npm ci
    - npm test
  rules:
    - changes:
        - src/**/*
        - scripts/**/*
      when: always
  allow_failure: true

app:lint:
  <<: *node_template
  stage: validate
  script:
    - cd src/lambdas/shared
    - npm ci
    - npm run lint || true
  rules:
    - changes:
        - src/**/*
      when: always
  allow_failure: true

# -----------------------------------------------------------------------------
# Build
# -----------------------------------------------------------------------------

app:build:
  <<: *node_template
  stage: build
  script:
    - chmod +x scripts/*.sh
    - ./scripts/build-all-lambdas.sh
  artifacts:
    paths:
      - src/lambdas/*/function.zip
    expire_in: 1 week
  rules:
    - changes:
        - src/**/*
        - scripts/**/*
      when: always

# -----------------------------------------------------------------------------
# Deploy Application Staging (automatique sur push)
# -----------------------------------------------------------------------------

app:deploy-staging:
  <<: *node_template
  stage: deploy-staging
  image: amazon/aws-cli:latest
  dependencies:
    - app:build
  script:
    - |
      for lambda_dir in src/lambdas/*/; do
        if [ -f "${lambda_dir}function.zip" ]; then
          lambda_name=$(basename "$lambda_dir")
          echo "Deploying $lambda_name to staging..."
          aws lambda update-function-code \
            --function-name "koumpa-staging-${lambda_name}" \
            --zip-file "fileb://${lambda_dir}function.zip" \
            --region $AWS_DEFAULT_REGION || true
        fi
      done
  environment:
    name: staging
    url: https://staging.koumpa.com
  rules:
    - if: '$CI_COMMIT_BRANCH == "staging"'
      changes:
        - src/**/*
        - scripts/**/*
      when: always

# -----------------------------------------------------------------------------
# Deploy Application Production (automatique après merge sur main)
# -----------------------------------------------------------------------------

app:deploy-prod:
  <<: *node_template
  stage: deploy-prod
  image: amazon/aws-cli:latest
  dependencies:
    - app:build
  script:
    - |
      for lambda_dir in src/lambdas/*/; do
        if [ -f "${lambda_dir}function.zip" ]; then
          lambda_name=$(basename "$lambda_dir")
          echo "Deploying $lambda_name to production..."
          aws lambda update-function-code \
            --function-name "koumpa-prod-${lambda_name}" \
            --zip-file "fileb://${lambda_dir}function.zip" \
            --region $AWS_DEFAULT_REGION || true
        fi
      done
  environment:
    name: production
    url: https://koumpa.com
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      changes:
        - src/**/*
        - scripts/**/*
      when: always

# =============================================================================
# FULL DEPLOYMENT JOBS (Infrastructure + Application together)
# =============================================================================

# Pour forcer un déploiement complet manuellement
full:deploy-staging:
  stage: deploy-staging
  trigger:
    include: .gitlab-ci.yml
    strategy: depend
  variables:
    FORCE_DEPLOY: "true"
  rules:
    - if: '$CI_COMMIT_BRANCH == "staging"'
      when: manual
      allow_failure: true

full:deploy-prod:
  stage: deploy-prod
  trigger:
    include: .gitlab-ci.yml
    strategy: depend
  variables:
    FORCE_DEPLOY: "true"
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
      when: manual
      allow_failure: true
